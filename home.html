<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coldi CRM ‚Äî –ì–ª–∞–≤–Ω–∞—è</title>
  <link rel="stylesheet" href="css/style.css" />

  <script>
    const role = localStorage.getItem("role");
    const user = localStorage.getItem("user");
    if (!role || !user) window.location.href = "login.html";
  </script>

</head>
<body>

  <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
  <aside class="sidebar">
    <div class="logo">
      <img src="img/logo.svg" alt="Logo" />
      <span>Coldi CRM</span>
    </div>
    <nav>
      <a href="home.html" class="active">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="leads.html">–õ–∏–¥—ã</a>
      <a href="notifications.html">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</a>
      <a href="admin.html" id="adminLink">–ê–¥–º–∏–Ω</a>
      <a href="#" class="logout-link" onclick="logout()">–í—ã—Ö–æ–¥</a>
    </nav>
  </aside>

  <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <header class="topbar">
    <div>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, <span id="roleTitle">–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>!</div>

    <div id="notificationIcon" class="notification-icon">
      <img src="img/bell.svg" alt="üîî" />
      <div id="notificationBadge" class="notification-badge" style="display: none;">0</div>
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="main-content">
    <div class="welcome-block">
      <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Coldi CRM</h1>
      <p>–î–µ–Ω—å –±–µ–∑ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –¥–µ–Ω—å –±–µ–∑ —Ä–æ—Å—Ç–∞.</p>
    </div>
  </main>

  <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
  <div id="notificationPopup" class="notification-popup" style="display: none;"></div>

  <script>
    // –†–æ–ª—å
    const role = localStorage.getItem("role") || "manager";
    document.getElementById("roleTitle").textContent = role === "admin" ? "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" : "–º–µ–Ω–µ–¥–∂–µ—Ä";

    // –°–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É "–ê–¥–º–∏–Ω", –µ—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω
    if (role !== "admin") {
      document.getElementById("adminLink").style.display = "none";
    }

    // –í—ã—Ö–æ–¥
    function logout() {
      localStorage.removeItem("role");
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }

    // –ü—Ä–∏–º–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    const bell = document.getElementById("notificationIcon");
    const popup = document.getElementById("notificationPopup");
    const badge = document.getElementById("notificationBadge");

    const reminders = JSON.parse(localStorage.getItem("crmClients") || "[]")
      .filter(c => {
        const role = localStorage.getItem("role");
        const currentUser = localStorage.getItem("user");
        const reminderTime = new Date(c.reminder);
        const now = new Date();
        return (
          c.reminder &&
          reminderTime <= now &&
          (role === "admin" || c.manager === currentUser)
        );
      });

    if (reminders.length) {
      badge.style.display = "block";
      badge.textContent = reminders.length;
      popup.innerHTML = reminders
        .map(c => `<div class="notification-item" onclick="openClient(${c.id})">
          üîî ${c.firstName} ${c.lastName}<br />
          <span class="notification-time">${new Date(c.reminder).toLocaleString()}</span>
        </div>`)
        .join("");
    } else {
      popup.innerHTML = '<div class="empty">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</div>';
    }

    bell.addEventListener("click", () => {
      popup.classList.toggle("active");
    });

    function openClient(id) {
      window.open(`client.html?id=${id}`, "_blank");
    }
  </script>
</body>
</html>
